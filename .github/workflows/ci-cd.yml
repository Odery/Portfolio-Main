name: CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  checks: write
  security-events: write

jobs:
  # --- CI Jobs ---
  # --- 1. Lint
  golangci:
    name: GO Lint Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: './go.mod'
          cache: true

      - name: golangci-lint
        uses: golangci/golangci-lint-action@1e7e51e771db61008b38414a730f564565cf7c20
        with:
          version: latest
          args: --timeout 5m0s

  # --- 2. Security Checks (with SARIF Reports)
  security:
    name: Trivy Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Create SARIF Directory
        run: mkdir -p sarif-reports

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        with:
          scan-type: 'fs'
          ignore-unfixed: true
          format: 'sarif'
          severity: 'MEDIUM,HIGH,CRITICAL'
          output: 'sarif-reports/trivy-results.sarif'

      - name: GoSec Security Scan
        uses: securego/gosec@master
        with:
          args: ' -no-fail -fmt sarif -out sarif-reports/go-results.sarif ./...'

      - name: Upload SARIF Reports
        uses: github/codeql-action/upload-sarif@7434149006143a4d75b82a2f411ef15b03ccc2d7
        with:
          sarif_file: sarif-reports

  # --- 3. Test And Coverage
  test:
    name: Tests And Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: './go.mod'
          cache: true

      - name: Run Tests and Generate Coverage Report
        run: go test -json -v -race -coverprofile=coverage.out -covermode=atomic ./... | tee test-report.json

      - name: Generate Coverage
        shell: bash
        run: |
          cov=$(go tool cover -func=coverage.out | tail -n 1 | awk '{print $3}')
          echo "$cov" >> coverage.txt
          echo "Coverage: $cov"

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: coverage.txt
          retention-days: 1
          if-no-files-found: error
          overwrite: 'true'

      - name: Upload Test Report
        uses: dorny/test-reporter@b082adf0eced0765477756c2a610396589b8c637
        if: ${{ !cancelled() }}
        with:
          name: Go Test Report
          path: test-report.json
          reporter: golang-json

  # --- 4. Build And Artifact Creation
  build:
    name: Build Artifact
    runs-on: ubuntu-latest
    needs: [golangci, test]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: './go.mod'
          cache: true

      - name: Build Artifact
        # Here we are injecting the commit SHA and branch name metadata into the binary, for traceability.
        env:
          GIT_SHA: ${{ github.sha }}
          GIT_REF: ${{ github.ref_name }}
        run: |
          go build -v \
          -ldflags "-X 'main.GitCommitSHA=$GIT_SHA' -X 'main.GitBranch=$GIT_REF'" \
          -o portfolio-app ./cmd/PortfolioWebsite

      - name: Upload Artifact
        uses: actions/upload-artifact@v6
        with:
          name: 'app-binary'
          path: portfolio-app
          retention-days: 1
          if-no-files-found: error
          overwrite: 'true'

  # --- 5. PR Comment
  pr-comment:
    name: PR test/coverage comment
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'pull_request'
    steps:
      - name: Download test metadat
        uses: actions/download-artifact@v7
        with:
          name: coverage-report
          path: ./metadata

      - name: Create PR comment
        shell: bash
        run: |
         cov=$(cat ./metadata/coverage.txt)
         {
           echo "### CI Summary"
           echo ""
           echo "- All Checks Passed"
           echo "- Tests: âœ… (see Checks for details)"
           echo "- Code Coverage: **$cov**"
           echo ""
           echo "<!-- CI Summary comment generated by CI/CD workflow -->"
         } > comment.md

      - name: Create or update comment
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-path: comment.md
          edit-mode: replace


  # --- CD Job ---
  deploy:
    name: Deploy to Production
    needs: [build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Download Artifact
        uses: actions/download-artifact@v7
        with:
          name: 'app-binary'
          path: ./dist

      - name: Deploy via SSH
        uses: ./.github/actions/deploy
        with:
          artifact-path: ./dist/portfolio-app
          ssh-host: ${{ secrets.SSH_HOST }}
          ssh-user: ${{ secrets.SSH_USER }}
          ssh-key: ${{ secrets.SSH_KEY }}

